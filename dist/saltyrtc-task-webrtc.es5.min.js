/**
 * saltyrtc-task-webrtc v0.13.0
 * A SaltyRTC WebRTC task implementation.
 * https://github.com/saltyrtc/saltyrtc-task-webrtc-js#readme
 *
 * Copyright (C) 2016-2018 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var saltyrtcTaskWebrtc=function(e,r){function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function t(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function a(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var o=function(){function a(e,t,n,i){s(this,a),this._cookie=e,this._overflow=n,this._sequenceNumber=i,this._channelId=t}return t(a,[{key:"toArrayBuffer",value:function(){var e=new ArrayBuffer(a.TOTAL_LENGTH);new Uint8Array(e).set(this._cookie.bytes);var t=new DataView(e);return t.setUint16(16,this._channelId),t.setUint16(18,this._overflow),t.setUint32(20,this._sequenceNumber),e}},{key:"toUint8Array",value:function(){return new Uint8Array(this.toArrayBuffer())}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return(this._overflow<<32)+this._sequenceNumber}},{key:"channelId",get:function(){return this._channelId}}],[{key:"fromArrayBuffer",value:function(e){if(e.byteLength!=a.TOTAL_LENGTH)throw"bad-packet-length";var t=new DataView(e);return new a(new saltyrtcClient.Cookie(new Uint8Array(e,0,16)),t.getUint16(16),t.getUint16(18),t.getUint32(20))}}]),a}();o.TOTAL_LENGTH=24;var d=function(){function i(e,t){var a=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"none";if(s(this,i),this.logTag="[SaltyRTC.SecureDataChannel]",this.messageNumber=0,this.chunkCount=0,this.onChunk=function(e){a.log.debug(a.logTag,"Received chunk"),e.data instanceof Blob?a.log.warn(a.logTag,"Received message in blob format, which is not currently supported."):"string"!=typeof e.data?(a.unchunker.add(new Uint8Array(e.data)),a.chunkCount++>i.CHUNK_COUNT_GC&&(a.unchunker.gc(i.CHUNK_MAX_AGE),a.chunkCount=0)):a.log.warn(a.logTag,"Received message in string format, which is not currently supported.")},this.onEncryptedMessage=function(e){if(void 0!==a._onmessage){a.log.debug(a.logTag,"Decrypting incoming data...");var t=saltyrtcClient.Box.fromUint8Array(new Uint8Array(e),r.box.nonceLength);try{a.validateNonce(o.fromArrayBuffer(t.nonce.buffer))}catch(e){return a.log.error(a.logTag,"Invalid nonce:",e),a.log.error(a.logTag,"Closing data channel"),a.close(),void a.task.close(saltyrtcClient.CloseCode.ProtocolError)}var n=a.task.getSignaling().decryptFromPeer(t),i={data:n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)};a._onmessage.bind(a.dc)(i)}},"arraybuffer"!==e.binaryType)throw new Error("Currently SaltyRTC can only handle data channels with `binaryType` set to `arraybuffer`.");if(this.dc=e,this.task=t,this.log=new saltyrtcClient.Log(n),this.cookiePair=new saltyrtcClient.CookiePair,this.csnPair=new saltyrtcClient.CombinedSequencePair,this.chunkSize=this.task.getMaxPacketSize(),null===this.chunkSize)throw new Error("Could not determine max chunk size");0===this.chunkSize?this.dc.onmessage=function(e){return a.onEncryptedMessage(e.data)}:(this.chunkBuffer=new ArrayBuffer(this.chunkSize),this.unchunker=new chunkedDc.UnreliableUnorderedUnchunker,this.unchunker.onMessage=this.onEncryptedMessage,this.dc.onmessage=this.onChunk)}return t(i,[{key:"send",value:function(e){var t;if(e instanceof Uint8Array)t=e;else if(e instanceof ArrayBuffer)t=new Uint8Array(e);else{if(!ArrayBuffer.isView(e))throw e instanceof Blob?new Error("SecureDataChannel does not currently support Blob data. Please pass in an ArrayBuffer or a typed array (e.g. Uint8Array)."):"string"==typeof e?new Error("SecureDataChannel can only handle binary data."):new Error("Unknown data type. Please pass in an ArrayBuffer or a typed array (e.g. Uint8Array).");t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}var n=this.encryptData(t).toUint8Array();if(0===this.chunkSize)this.dc.send(n);else{var i=new chunkedDc.UnreliableUnorderedChunker(this.messageNumber++,n,this.chunkSize,this.chunkBuffer),a=!0,r=!1,s=void 0;try{for(var o,d=i[Symbol.iterator]();!(a=(o=d.next()).done);a=!0){var l=o.value;this.dc.send(l)}}catch(e){r=!0,s=e}finally{try{a||null==d.return||d.return()}finally{if(r)throw s}}}}},{key:"encryptData",value:function(e){var t=this.csnPair.ours.next(),n=new o(this.cookiePair.ours,this.dc.id,t.overflow,t.sequenceNumber);return this.task.getSignaling().encryptForPeer(e,n.toUint8Array())}},{key:"validateNonce",value:function(e){if(e.cookie.equals(this.cookiePair.ours))throw new Error("Local and remote cookie are equal");if(null===this.cookiePair.theirs||void 0===this.cookiePair.theirs)this.cookiePair.theirs=e.cookie;else if(!e.cookie.equals(this.cookiePair.theirs))throw new Error("Remote cookie changed");if(null!=this.lastIncomingCsn&&e.combinedSequenceNumber==this.lastIncomingCsn)throw new Error("CSN reuse detected!");if(e.channelId!=this.dc.id)throw new Error("Data channel id in nonce does not match actual data channel id");this.lastIncomingCsn=e.combinedSequenceNumber}},{key:"close",value:function(){this.dc.close()}},{key:"addEventListener",value:function(e,t,n){if("message"===e)throw new Error("addEventListener on message events is not currently supported by SaltyRTC.");this.dc.addEventListener(e,t,n)}},{key:"removeEventListener",value:function(e,t,n){if("message"===e)throw new Error("removeEventListener on message events is not currently supported by SaltyRTC.");this.dc.removeEventListener(e,t,n)}},{key:"dispatchEvent",value:function(e){return this.dc.dispatchEvent(e)}},{key:"label",get:function(){return this.dc.label}},{key:"ordered",get:function(){return this.dc.ordered}},{key:"maxPacketLifeTime",get:function(){return this.dc.maxPacketLifeTime}},{key:"maxRetransmits",get:function(){return this.dc.maxRetransmits}},{key:"protocol",get:function(){return this.dc.protocol}},{key:"negotiated",get:function(){return this.dc.negotiated}},{key:"id",get:function(){return this.dc.id}},{key:"readyState",get:function(){return this.dc.readyState}},{key:"bufferedAmount",get:function(){return this.dc.bufferedAmount}},{key:"bufferedAmountLowThreshold",get:function(){return this.dc.bufferedAmountLowThreshold},set:function(e){this.dc.bufferedAmountLowThreshold=e}},{key:"binaryType",get:function(){return this.dc.binaryType},set:function(e){this.dc.binaryType=e}},{key:"onopen",get:function(){return this.dc.onopen},set:function(e){this.dc.onopen=e}},{key:"onbufferedamountlow",get:function(){return this.dc.onbufferedamountlow},set:function(e){this.dc.onbufferedamountlow=e}},{key:"onerror",get:function(){return this.dc.onerror},set:function(e){this.dc.onerror=e}},{key:"onclose",get:function(){return this.dc.onclose},set:function(e){this.dc.onclose=e}},{key:"onmessage",get:function(){return this.dc.onmessage},set:function(e){this._onmessage=e}}]),i}();d.CHUNK_COUNT_GC=32,d.CHUNK_MAX_AGE=6e4;var n=function(){function i(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:i.DEFAULT_MAX_PACKET_SIZE,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"none";s(this,i),this.logTag="[SaltyRTC.WebRTC]",this.initialized=!1,this.exclude=new Set,this.doHandover=!0,this.sdc=null,this.eventRegistry=new saltyrtcClient.EventRegistry,this.candidates=[],this.sendCandidatesTimeout=null,this.log=new saltyrtcClient.Log(n),this.doHandover=e,this.requestedMaxPacketSize=t}return t(i,[{key:"init",value:function(e,t){this.processExcludeList(t[i.FIELD_EXCLUDE]),this.processMaxPacketSize(t[i.FIELD_MAX_PACKET_SIZE]),this.processHandover(t[i.FIELD_HANDOVER]),this.signaling=e,this.initialized=!0}},{key:"processExcludeList",value:function(e){var t=!0,n=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(t=(a=r.next()).done);t=!0){var s=a.value;this.exclude.add(s)}}catch(e){n=!0,i=e}finally{try{t||null==r.return||r.return()}finally{if(n)throw i}}for(var o=0;o<=65535;o++)if(!this.exclude.has(o)){this.sdcId=o;break}if(void 0===this.sdcId&&!0===this.doHandover)throw new Error("Exclude list is too big, no free data channel id can be found")}},{key:"processMaxPacketSize",value:function(e){if(!Number.isInteger(e))throw new RangeError(i.FIELD_MAX_PACKET_SIZE+" field must be an integer");if(e<0)throw new RangeError(i.FIELD_MAX_PACKET_SIZE+" field must be positive");0===e&&0===this.requestedMaxPacketSize?this.negotiatedMaxPacketSize=0:0===e||0===this.requestedMaxPacketSize?this.negotiatedMaxPacketSize=Math.max(e,this.requestedMaxPacketSize):this.negotiatedMaxPacketSize=Math.min(e,this.requestedMaxPacketSize),this.log.debug(this.logTag,"Max packet size: We requested",this.requestedMaxPacketSize,"bytes, peer requested",e,"bytes. Using",this.negotiatedMaxPacketSize+".")}},{key:"processHandover",value:function(e){!1===e&&(this.doHandover=!1)}},{key:"onPeerHandshakeDone",value:function(){}},{key:"onDisconnected",value:function(e){this.emit({type:"disconnected",data:e})}},{key:"onTaskMessage",value:function(e){switch(this.log.debug(this.logTag,"New task message arrived: "+e.type),e.type){case"offer":if(!0!==this.validateOffer(e))return;this.emit({type:"offer",data:e.offer});break;case"answer":if(!0!==this.validateAnswer(e))return;this.emit({type:"answer",data:e.answer});break;case"candidates":if(!0!==this.validateCandidates(e))return;this.emit({type:"candidates",data:e.candidates});break;case"handover":if(!1===this.doHandover){this.log.error(this.logTag,"Received unexpected handover message from peer"),this.signaling.resetConnection(saltyrtcClient.CloseCode.ProtocolError);break}!1===this.signaling.handoverState.local&&this.sendHandover(),this.signaling.handoverState.peer=!0,this.signaling.handoverState.both&&this.log.info(this.logTag,"Handover to data channel finished");break;default:this.log.error(this.logTag,"Received message with unknown type:",e.type)}}},{key:"validateOffer",value:function(e){return void 0===e.offer?(this.log.warn(this.logTag,"Offer message does not contain offer"),!1):void 0!==e.offer.sdp||(this.log.warn(this.logTag,"Offer message does not contain offer sdp"),!1)}},{key:"validateAnswer",value:function(e){return void 0===e.answer?(this.log.warn(this.logTag,"Answer message does not contain answer"),!1):void 0!==e.answer.sdp||(this.log.warn(this.logTag,"Answer message does not contain answer sdp"),!1)}},{key:"validateCandidates",value:function(e){if(void 0===e.candidates)return this.log.warn(this.logTag,"Candidates message does not contain candidates"),!1;if(e.candidates.length<1)return this.log.warn(this.logTag,"Candidates message contains empty candidate list"),!1;var t=!0,n=!1,i=void 0;try{for(var a,r=e.candidates[Symbol.iterator]();!(t=(a=r.next()).done);t=!0){var s=a.value;if(null!==s){if("string"!=typeof s.candidate&&!(s.candidate instanceof String))return this.log.warn(this.logTag,"Candidates message contains invalid candidate (candidate field)"),!1;if("string"!=typeof s.sdpMid&&!(s.sdpMid instanceof String)&&null!==s.sdpMid)return this.log.warn(this.logTag,"Candidates message contains invalid candidate (sdpMid field)"),!1;if(null!==s.sdpMLineIndex&&!Number.isInteger(s.sdpMLineIndex))return this.log.warn(this.logTag,"Candidates message contains invalid candidate (sdpMLineIndex field)"),!1}}}catch(e){n=!0,i=e}finally{try{t||null==r.return||r.return()}finally{if(n)throw i}}return!0}},{key:"sendSignalingMessage",value:function(e){if("task"!=this.signaling.getState())throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Signaling state is not open.");if(!1===this.signaling.handoverState.local)throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Handover hasn't happened yet.");this.sdc.send(e)}},{key:"getName",value:function(){return i.PROTOCOL_NAME}},{key:"getSupportedMessageTypes",value:function(){return["offer","answer","candidates","handover"]}},{key:"getMaxPacketSize",value:function(){return!0===this.initialized?this.negotiatedMaxPacketSize:null}},{key:"getData",value:function(){var e={};return e[i.FIELD_EXCLUDE]=Array.from(this.exclude.values()),e[i.FIELD_MAX_PACKET_SIZE]=this.requestedMaxPacketSize,e[i.FIELD_HANDOVER]=this.doHandover,e}},{key:"getSignaling",value:function(){return this.signaling}},{key:"sendOffer",value:function(e){this.log.debug(this.logTag,"Sending offer");try{this.signaling.sendTaskMessage({type:"offer",offer:{type:e.type,sdp:e.sdp}})}catch(e){"SignalingError"===e.name&&(this.log.error(this.logTag,"Could not send offer:",e.message),this.signaling.resetConnection(e.closeCode))}}},{key:"sendAnswer",value:function(e){this.log.debug(this.logTag,"Sending answer");try{this.signaling.sendTaskMessage({type:"answer",answer:{type:e.type,sdp:e.sdp}})}catch(e){"SignalingError"===e.name&&(this.log.error(this.logTag,"Could not send answer:",e.message),this.signaling.resetConnection(e.closeCode))}}},{key:"sendCandidate",value:function(e){this.sendCandidates([e])}},{key:"sendCandidates",value:function(e){var t,n=this;this.log.debug(this.logTag,"Buffering",e.length,"candidate(s)"),(t=this.candidates).push.apply(t,a(e));null===this.sendCandidatesTimeout&&(this.sendCandidatesTimeout=window.setTimeout(function(){try{n.log.debug(n.logTag,"Sending",n.candidates.length,"candidate(s)"),n.signaling.sendTaskMessage({type:"candidates",candidates:n.candidates})}catch(e){"SignalingError"===e.name&&(n.log.error(n.logTag,"Could not send candidates:",e.message),n.signaling.resetConnection(e.closeCode))}finally{n.candidates=[],n.sendCandidatesTimeout=null}},i.CANDIDATE_BUFFERING_MS))}},{key:"handover",value:function(e){var n=this;if(this.log.debug(this.logTag,"Initiate handover"),!1===this.doHandover)return this.log.error(this.logTag,"Cannot do handover: Either us or our peer set handover=false"),!1;if(this.signaling.handoverState.any)return this.log.error(this.logTag,"Handover already in progress or finished"),!1;if(void 0===this.sdcId||null===this.sdcId)throw this.log.error(this.logTag,"Data channel id not set"),this.signaling.resetConnection(saltyrtcClient.CloseCode.InternalError),new Error("Data channel id not set");var t=e.createDataChannel(i.DC_LABEL,{id:this.sdcId,negotiated:!0,ordered:!0,protocol:i.PROTOCOL_NAME});return t.binaryType="arraybuffer",this.sdc=new d(t,this,this.log.level),this.sdc.onopen=function(e){n.sendHandover()},this.sdc.onclose=function(e){n.signaling.handoverState.any&&n.signaling.setState("closed")},this.sdc.onerror=function(e){n.log.error(n.logTag,"Signaling data channel error:",e)},this.sdc.onbufferedamountlow=function(e){n.log.warn(n.logTag,"Signaling data channel: Buffered amount low:",e)},this.sdc.onmessage=function(e){var t=new Uint8Array(e.data);n.signaling.onSignalingPeerMessage(t)},!0}},{key:"sendHandover",value:function(){this.log.debug(this.logTag,"Sending handover");try{this.signaling.sendTaskMessage({type:"handover"})}catch(e){"SignalingError"===e.name&&(this.log.error(this.logTag,"Could not send handover message",e.message),this.signaling.resetConnection(e.closeCode))}this.signaling.handoverState.local=!0,this.signaling.handoverState.both&&this.log.info(this.logTag,"Handover to data channel finished")}},{key:"wrapDataChannel",value:function(e){return this.log.debug(this.logTag,"Wrapping data channel",e.id),new d(e,this,this.log.level)}},{key:"close",value:function(e){this.log.debug(this.logTag,"Closing signaling data channel:",saltyrtcClient.explainCloseCode(e)),null!==this.sdc&&this.sdc.close(),this.sdc=null}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,i){var a=this;this.eventRegistry.register(e,function t(n){try{i(n)}catch(e){throw a.off(n.type,t),e}a.off(n.type,t)})}},{key:"off",value:function(e,t){void 0===e?this.eventRegistry.unregisterAll():this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(t){this.log.debug(this.logTag,"New event:",t.type);var e=this.eventRegistry.get(t.type),n=!0,i=!1,a=void 0;try{for(var r,s=e[Symbol.iterator]();!(n=(r=s.next()).done);n=!0){var o=r.value;try{this.callHandler(o,t)}catch(e){this.log.error(this.logTag,"Unhandled exception in",t.type,"handler:",e)}}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}}},{key:"callHandler",value:function(e,t){!1===e(t)&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",set:function(e){this._signaling=e,this.logTag="[SaltyRTC.WebRTC."+e.role+"]"},get:function(){return this._signaling}}]),i}();return n.PROTOCOL_NAME="v0.webrtc.tasks.saltyrtc.org",n.DEFAULT_MAX_PACKET_SIZE=16384,n.FIELD_EXCLUDE="exclude",n.FIELD_MAX_PACKET_SIZE="max_packet_size",n.FIELD_HANDOVER="handover",n.DC_LABEL="saltyrtc-signaling",n.CANDIDATE_BUFFERING_MS=5,e.WebRTCTask=n,e}({},nacl);
