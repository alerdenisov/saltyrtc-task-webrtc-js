/**
 * saltyrtc-task-webrtc v0.12.1
 * A SaltyRTC WebRTC task implementation.
 * https://github.com/saltyrtc/saltyrtc-task-webrtc-js#readme
 *
 * Copyright (C) 2016-2018 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var saltyrtcTaskWebrtc=function(e,c){function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e,n,t){return n&&i(e.prototype,n),t&&i(e,t),e}function a(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var d=function(){function a(e,n,t,i){r(this,a),this._cookie=e,this._overflow=t,this._sequenceNumber=i,this._channelId=n}return n(a,[{key:"toArrayBuffer",value:function(){var e=new ArrayBuffer(a.TOTAL_LENGTH);new Uint8Array(e).set(this._cookie.bytes);var n=new DataView(e);return n.setUint16(16,this._channelId),n.setUint16(18,this._overflow),n.setUint32(20,this._sequenceNumber),e}},{key:"toUint8Array",value:function(){return new Uint8Array(this.toArrayBuffer())}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return(this._overflow<<32)+this._sequenceNumber}},{key:"channelId",get:function(){return this._channelId}}],[{key:"fromArrayBuffer",value:function(e){if(e.byteLength!=a.TOTAL_LENGTH)throw"bad-packet-length";var n=new DataView(e);return new a(new saltyrtcClient.Cookie(new Uint8Array(e,0,16)),n.getUint16(16),n.getUint16(18),n.getUint32(20))}}]),a}();d.TOTAL_LENGTH=24;var o=function(){function t(e,n){var s=this;if(r(this,t),this.logTag="[SaltyRTC.SecureDataChannel]",this.messageNumber=0,this.chunkCount=0,this.onChunk=function(e){console.debug(s.logTag,"Received chunk"),e.data instanceof Blob?console.warn(s.logTag,"Received message in blob format, which is not currently supported."):"string"!=typeof e.data?e.data instanceof ArrayBuffer?(s.unchunker.add(e.data,e),s.chunkCount++>t.CHUNK_COUNT_GC&&(s.unchunker.gc(t.CHUNK_MAX_AGE),s.chunkCount=0)):console.warn(s.logTag,"Received message in unsupported format. Please send ArrayBuffer objects."):console.warn(s.logTag,"Received message in string format, which is not currently supported.")},this.onEncryptedMessage=function(e,n){if(void 0!==s._onmessage){console.debug(s.logTag,"Decrypting incoming data...");var t=n[n.length-1],i={};for(var a in t)i[a]=t[a];var r=saltyrtcClient.Box.fromUint8Array(new Uint8Array(e),c.box.nonceLength);try{s.validateNonce(d.fromArrayBuffer(r.nonce.buffer))}catch(e){return console.error(s.logTag,"Invalid nonce:",e),console.error(s.logTag,"Closing data channel"),s.close(),void s.task.close(saltyrtcClient.CloseCode.ProtocolError)}var o=s.task.getSignaling().decryptFromPeer(r);i.data=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),s._onmessage.bind(s.dc)(i)}},"arraybuffer"!==e.binaryType)throw new Error("Currently SaltyRTC can only handle data channels with `binaryType` set to `arraybuffer`.");if(this.dc=e,this.task=n,this.cookiePair=new saltyrtcClient.CookiePair,this.csnPair=new saltyrtcClient.CombinedSequencePair,this.chunkSize=this.task.getMaxPacketSize(),null===this.chunkSize)throw new Error("Could not determine max chunk size");0===this.chunkSize?this.dc.onmessage=function(e){return s.onEncryptedMessage(e.data,[e])}:(this.unchunker=new chunkedDc.Unchunker,this.unchunker.onMessage=this.onEncryptedMessage,this.dc.onmessage=this.onChunk)}return n(t,[{key:"send",value:function(e){var n;if("string"==typeof e)throw new Error("SecureDataChannel can only handle binary data.");if(e instanceof Blob)throw new Error("SecureDataChannel does not currently support Blob data. Please pass in an ArrayBuffer or a typed array (e.g. Uint8Array).");if(e instanceof Int8Array||e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof DataView){var t=e.byteOffset||0,i=t+(e.byteLength||e.buffer.byteLength);n=e.buffer.slice(t,i)}else if(e instanceof Uint8Array)n=e.buffer;else{if(!(e instanceof ArrayBuffer))throw new Error("Unknown data type. Please pass in an ArrayBuffer or a typed array (e.g. Uint8Array).");n=e}var a=this.encryptData(new Uint8Array(n)).toUint8Array();if(0===this.chunkSize)this.dc.send(a);else{var r=new chunkedDc.Chunker(this.messageNumber++,a,this.chunkSize),o=!0,s=!1,c=void 0;try{for(var d,l=r[Symbol.iterator]();!(o=(d=l.next()).done);o=!0){var u=d.value;this.dc.send(u)}}catch(e){s=!0,c=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw c}}}}},{key:"encryptData",value:function(e){var n=this.csnPair.ours.next(),t=new d(this.cookiePair.ours,this.dc.id,n.overflow,n.sequenceNumber);return this.task.getSignaling().encryptForPeer(e,t.toUint8Array())}},{key:"validateNonce",value:function(e){if(e.cookie.equals(this.cookiePair.ours))throw new Error("Local and remote cookie are equal");if(null===this.cookiePair.theirs||void 0===this.cookiePair.theirs)this.cookiePair.theirs=e.cookie;else if(!e.cookie.equals(this.cookiePair.theirs))throw new Error("Remote cookie changed");if(null!=this.lastIncomingCsn&&e.combinedSequenceNumber==this.lastIncomingCsn)throw new Error("CSN reuse detected!");if(e.channelId!=this.dc.id)throw new Error("Data channel id in nonce does not match actual data channel id");this.lastIncomingCsn=e.combinedSequenceNumber}},{key:"close",value:function(){this.dc.close()}},{key:"addEventListener",value:function(e,n,t){if("message"===e)throw new Error("addEventListener on message events is not currently supported by SaltyRTC.");this.dc.addEventListener(e,n,t)}},{key:"removeEventListener",value:function(e,n,t){if("message"===e)throw new Error("removeEventListener on message events is not currently supported by SaltyRTC.");this.dc.removeEventListener(e,n,t)}},{key:"dispatchEvent",value:function(e){return this.dc.dispatchEvent(e)}},{key:"label",get:function(){return this.dc.label}},{key:"ordered",get:function(){return this.dc.ordered}},{key:"maxPacketLifeTime",get:function(){return this.dc.maxPacketLifeTime}},{key:"maxRetransmits",get:function(){return this.dc.maxRetransmits}},{key:"protocol",get:function(){return this.dc.protocol}},{key:"negotiated",get:function(){return this.dc.negotiated}},{key:"id",get:function(){return this.dc.id}},{key:"readyState",get:function(){return this.dc.readyState}},{key:"bufferedAmount",get:function(){return this.dc.bufferedAmount}},{key:"bufferedAmountLowThreshold",get:function(){return this.dc.bufferedAmountLowThreshold},set:function(e){this.dc.bufferedAmountLowThreshold=e}},{key:"binaryType",get:function(){return this.dc.binaryType},set:function(e){this.dc.binaryType=e}},{key:"onopen",get:function(){return this.dc.onopen},set:function(e){this.dc.onopen=e}},{key:"onbufferedamountlow",get:function(){return this.dc.onbufferedamountlow},set:function(e){this.dc.onbufferedamountlow=e}},{key:"onerror",get:function(){return this.dc.onerror},set:function(e){this.dc.onerror=e}},{key:"onclose",get:function(){return this.dc.onclose},set:function(e){this.dc.onclose=e}},{key:"onmessage",get:function(){return this.dc.onmessage},set:function(e){this._onmessage=e}}]),t}();o.CHUNK_COUNT_GC=32,o.CHUNK_MAX_AGE=6e4;var t=function(){function i(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:i.DEFAULT_MAX_PACKET_SIZE;r(this,i),this.initialized=!1,this.exclude=new Set,this.doHandover=!0,this.sdc=null,this.eventRegistry=new saltyrtcClient.EventRegistry,this.candidates=[],this.sendCandidatesTimeout=null,this.doHandover=e,this.requestedMaxPacketSize=n}return n(i,[{key:"init",value:function(e,n){this.processExcludeList(n[i.FIELD_EXCLUDE]),this.processMaxPacketSize(n[i.FIELD_MAX_PACKET_SIZE]),this.processHandover(n[i.FIELD_HANDOVER]),this.signaling=e,this.initialized=!0}},{key:"processExcludeList",value:function(e){var n=!0,t=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(n=(a=r.next()).done);n=!0){var o=a.value;this.exclude.add(o)}}catch(e){t=!0,i=e}finally{try{n||null==r.return||r.return()}finally{if(t)throw i}}for(var s=0;s<=65535;s++)if(!this.exclude.has(s)){this.sdcId=s;break}if(void 0===this.sdcId&&!0===this.doHandover)throw new Error("Exclude list is too big, no free data channel id can be found")}},{key:"processMaxPacketSize",value:function(e){if(!Number.isInteger(e))throw new RangeError(i.FIELD_MAX_PACKET_SIZE+" field must be an integer");if(e<0)throw new RangeError(i.FIELD_MAX_PACKET_SIZE+" field must be positive");0===e&&0===this.requestedMaxPacketSize?this.negotiatedMaxPacketSize=0:0===e||0===this.requestedMaxPacketSize?this.negotiatedMaxPacketSize=Math.max(e,this.requestedMaxPacketSize):this.negotiatedMaxPacketSize=Math.min(e,this.requestedMaxPacketSize),console.debug(this.logTag,"Max packet size: We requested",this.requestedMaxPacketSize,"bytes, peer requested",e,"bytes. Using",this.negotiatedMaxPacketSize+".")}},{key:"processHandover",value:function(e){!1===e&&(this.doHandover=!1)}},{key:"onPeerHandshakeDone",value:function(){}},{key:"onDisconnected",value:function(e){this.emit({type:"disconnected",data:e})}},{key:"onTaskMessage",value:function(e){switch(console.debug(this.logTag,"New task message arrived: "+e.type),e.type){case"offer":if(!0!==this.validateOffer(e))return;this.emit({type:"offer",data:e.offer});break;case"answer":if(!0!==this.validateAnswer(e))return;this.emit({type:"answer",data:e.answer});break;case"candidates":if(!0!==this.validateCandidates(e))return;this.emit({type:"candidates",data:e.candidates});break;case"handover":if(!1===this.doHandover){console.error(this.logTag,"Received unexpected handover message from peer"),this.signaling.resetConnection(saltyrtcClient.CloseCode.ProtocolError);break}!1===this.signaling.handoverState.local&&this.sendHandover(),this.signaling.handoverState.peer=!0,this.signaling.handoverState.both&&console.info(this.logTag,"Handover to data channel finished");break;default:console.error(this.logTag,"Received message with unknown type:",e.type)}}},{key:"validateOffer",value:function(e){return void 0===e.offer?(console.warn(this.logTag,"Offer message does not contain offer"),!1):void 0!==e.offer.sdp||(console.warn(this.logTag,"Offer message does not contain offer sdp"),!1)}},{key:"validateAnswer",value:function(e){return void 0===e.answer?(console.warn(this.logTag,"Answer message does not contain answer"),!1):void 0!==e.answer.sdp||(console.warn(this.logTag,"Answer message does not contain answer sdp"),!1)}},{key:"validateCandidates",value:function(e){if(void 0===e.candidates)return console.warn(this.logTag,"Candidates message does not contain candidates"),!1;if(e.candidates.length<1)return console.warn(this.logTag,"Candidates message contains empty candidate list"),!1;var n=!0,t=!1,i=void 0;try{for(var a,r=e.candidates[Symbol.iterator]();!(n=(a=r.next()).done);n=!0){var o=a.value;if(null!==o){if("string"!=typeof o.candidate&&!(o.candidate instanceof String))return console.warn(this.logTag,"Candidates message contains invalid candidate (candidate field)"),!1;if("string"!=typeof o.sdpMid&&!(o.sdpMid instanceof String)&&null!==o.sdpMid)return console.warn(this.logTag,"Candidates message contains invalid candidate (sdpMid field)"),!1;if(null!==o.sdpMLineIndex&&!Number.isInteger(o.sdpMLineIndex))return console.warn(this.logTag,"Candidates message contains invalid candidate (sdpMLineIndex field)"),!1}}}catch(e){t=!0,i=e}finally{try{n||null==r.return||r.return()}finally{if(t)throw i}}return!0}},{key:"sendSignalingMessage",value:function(e){if("task"!=this.signaling.getState())throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Signaling state is not open.");if(!1===this.signaling.handoverState.local)throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Handover hasn't happened yet.");this.sdc.send(e)}},{key:"getName",value:function(){return i.PROTOCOL_NAME}},{key:"getSupportedMessageTypes",value:function(){return["offer","answer","candidates","handover"]}},{key:"getMaxPacketSize",value:function(){return!0===this.initialized?this.negotiatedMaxPacketSize:null}},{key:"getData",value:function(){var e={};return e[i.FIELD_EXCLUDE]=Array.from(this.exclude.values()),e[i.FIELD_MAX_PACKET_SIZE]=this.requestedMaxPacketSize,e[i.FIELD_HANDOVER]=this.doHandover,e}},{key:"getSignaling",value:function(){return this.signaling}},{key:"sendOffer",value:function(e){console.debug(this.logTag,"Sending offer");try{this.signaling.sendTaskMessage({type:"offer",offer:{type:e.type,sdp:e.sdp}})}catch(e){"SignalingError"===e.name&&(console.error(this.logTag,"Could not send offer:",e.message),this.signaling.resetConnection(e.closeCode))}}},{key:"sendAnswer",value:function(e){console.debug(this.logTag,"Sending answer");try{this.signaling.sendTaskMessage({type:"answer",answer:{type:e.type,sdp:e.sdp}})}catch(e){"SignalingError"===e.name&&(console.error(this.logTag,"Could not send answer:",e.message),this.signaling.resetConnection(e.closeCode))}}},{key:"sendCandidate",value:function(e){this.sendCandidates([e])}},{key:"sendCandidates",value:function(e){var n,t=this;console.debug(this.logTag,"Buffering",e.length,"candidate(s)"),(n=this.candidates).push.apply(n,a(e));null===this.sendCandidatesTimeout&&(this.sendCandidatesTimeout=window.setTimeout(function(){try{console.debug(t.logTag,"Sending",t.candidates.length,"candidate(s)"),t.signaling.sendTaskMessage({type:"candidates",candidates:t.candidates})}catch(e){"SignalingError"===e.name&&(console.error(t.logTag,"Could not send candidates:",e.message),t.signaling.resetConnection(e.closeCode))}finally{t.candidates=[],t.sendCandidatesTimeout=null}},i.CANDIDATE_BUFFERING_MS))}},{key:"handover",value:function(e){var t=this;if(console.debug(this.logTag,"Initiate handover"),!1===this.doHandover)return console.error(this.logTag,"Cannot do handover: Either us or our peer set handover=false"),!1;if(this.signaling.handoverState.any)return console.error(this.logTag,"Handover already in progress or finished"),!1;if(void 0===this.sdcId||null===this.sdcId)throw console.error(this.logTag,"Data channel id not set"),this.signaling.resetConnection(saltyrtcClient.CloseCode.InternalError),new Error("Data channel id not set");var n=e.createDataChannel(i.DC_LABEL,{id:this.sdcId,negotiated:!0,ordered:!0,protocol:i.PROTOCOL_NAME});return n.binaryType="arraybuffer",this.sdc=new o(n,this),this.sdc.onopen=function(e){t.sendHandover()},this.sdc.onclose=function(e){t.signaling.handoverState.any&&t.signaling.setState("closed")},this.sdc.onerror=function(e){console.error(t.logTag,"Signaling data channel error:",e)},this.sdc.onbufferedamountlow=function(e){console.warn(t.logTag,"Signaling data channel: Buffered amount low:",e)},this.sdc.onmessage=function(e){var n=new Uint8Array(e.data);t.signaling.onSignalingPeerMessage(n)},!0}},{key:"sendHandover",value:function(){console.debug(this.logTag,"Sending handover");try{this.signaling.sendTaskMessage({type:"handover"})}catch(e){"SignalingError"===e.name&&(console.error(this.logTag,"Could not send handover message",e.message),this.signaling.resetConnection(e.closeCode))}this.signaling.handoverState.local=!0,this.signaling.handoverState.both&&console.info(this.logTag,"Handover to data channel finished")}},{key:"wrapDataChannel",value:function(e){return console.debug(this.logTag,"Wrapping data channel",e.id),new o(e,this)}},{key:"close",value:function(e){console.debug(this.logTag,"Closing signaling data channel:",saltyrtcClient.explainCloseCode(e)),null!==this.sdc&&this.sdc.close(),this.sdc=null}},{key:"on",value:function(e,n){this.eventRegistry.register(e,n)}},{key:"once",value:function(e,i){var a=this;this.eventRegistry.register(e,function n(t){try{i(t)}catch(e){throw a.off(t.type,n),e}a.off(t.type,n)})}},{key:"off",value:function(e,n){void 0===e?this.eventRegistry.unregisterAll():this.eventRegistry.unregister(e,n)}},{key:"emit",value:function(n){console.debug(this.logTag,"New event:",n.type);var e=this.eventRegistry.get(n.type),t=!0,i=!1,a=void 0;try{for(var r,o=e[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var s=r.value;try{this.callHandler(s,n)}catch(e){console.error(this.logTag,"Unhandled exception in",n.type,"handler:",e)}}}catch(e){i=!0,a=e}finally{try{t||null==o.return||o.return()}finally{if(i)throw a}}}},{key:"callHandler",value:function(e,n){!1===e(n)&&this.eventRegistry.unregister(n.type,e)}},{key:"logTag",get:function(){return null===this.signaling||void 0===this.signaling?"[SaltyRTC.WebRTC]":"[SaltyRTC.WebRTC."+this.signaling.role+"]"}}]),i}();return t.PROTOCOL_NAME="v0.webrtc.tasks.saltyrtc.org",t.DEFAULT_MAX_PACKET_SIZE=16384,t.FIELD_EXCLUDE="exclude",t.FIELD_MAX_PACKET_SIZE="max_packet_size",t.FIELD_HANDOVER="handover",t.DC_LABEL="saltyrtc-signaling",t.CANDIDATE_BUFFERING_MS=5,e.WebRTCTask=t,e}({},nacl);
